name: anyrouter checkin

on:
  workflow_dispatch:
    inputs:
      accounts:
        description: "Optional ACCOUNTS JSON. Empty uses secrets.ACCOUNTS."
        required: false
        type: string
        default: ""
      providers:
        description: "Optional PROVIDERS JSON. Empty uses secrets.PROVIDERS."
        required: false
        type: string
        default: ""
      provider:
        description: "Provider to test."
        required: false
        type: string
        default: "anyrouter"
      debug:
        description: "Enable debug mode."
        required: false
        type: boolean
        default: true

jobs:
  checkin:
    permissions:
      id-token: write
      contents: read
    runs-on: windows-2025
    environment: production
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - name: set beijing timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneWindows: "China Standard Time"

      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v3
        with:
          version: latest

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: cache uv
        uses: actions/cache@v4
        id: uv-cache
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: install deps
        if: steps.uv-cache.outputs.cache-hit != 'true'
        run: uv sync

      - name: get camoufox version
        id: camoufox-version
        run: |
          $version = uv run python -c "import importlib.metadata; print(importlib.metadata.version('camoufox'))"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: cache camoufox
        uses: actions/cache@v4
        id: camoufox-cache
        with:
          path: ~\AppData\Local\camoufox
          key: ${{ runner.os }}-camoufox-${{ steps.camoufox-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-camoufox-

      - name: install camoufox
        if: steps.camoufox-cache.outputs.cache-hit != 'true'
        run: uv run camoufox fetch

      - name: restore storage-states cache
        uses: actions/cache/restore@v4
        with:
          path: |
            storage-states
          key: storage-state-${{ hashFiles('storage-states/*.json') }}
          restore-keys: |
            storage-state-

      - name: filter accounts by provider
        env:
          ACCOUNTS_RAW: ${{ inputs.accounts || secrets.ACCOUNTS }}
          TARGET_PROVIDER: ${{ inputs.provider || 'anyrouter' }}
        run: |
          $raw = "$env:ACCOUNTS_RAW".Trim()
          if (-not $raw) {
            throw "ACCOUNTS is empty. Provide workflow input 'accounts' or set secrets.ACCOUNTS."
          }

          try {
            $accounts = $raw | ConvertFrom-Json -Depth 100
          } catch {
            throw "Failed to parse ACCOUNTS JSON: $($_.Exception.Message)"
          }

          if ($accounts -is [System.Collections.IDictionary] -or $accounts -is [pscustomobject]) {
            throw "ACCOUNTS must be a JSON array."
          }

          $filtered = @(
            $accounts | Where-Object {
              $providerName = if ($null -eq $_.provider -or [string]::IsNullOrWhiteSpace([string]$_.provider)) {
                "anyrouter"
              } else {
                [string]$_.provider
              }
              $providerName -eq $env:TARGET_PROVIDER
            }
          )
          if ($filtered.Count -eq 0) {
            throw "No accounts found for provider '$env:TARGET_PROVIDER'."
          }

          $filteredJson = $filtered | ConvertTo-Json -Depth 100 -Compress
          Write-Host "Selected provider: $env:TARGET_PROVIDER, account count: $($filtered.Count)"

          $delimiter = "EOF_" + [Guid]::NewGuid().ToString("N")
          "ACCOUNTS<<$delimiter" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          $filteredJson | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$delimiter" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: run anyrouter checkin
        env:
          ACCOUNTS_LINUX_DO: ${{ secrets.ACCOUNTS_LINUX_DO }}
          ACCOUNTS_GITHUB: ${{ secrets.ACCOUNTS_GITHUB }}
          PROVIDERS: ${{ inputs.providers || secrets.PROVIDERS }}
          PROXY: ${{ secrets.PROXY }}
          DEBUG: ${{ github.event_name == 'workflow_dispatch' && inputs.debug || vars.DEBUG || 'false' }}
          CHECKIN_NOTIFY_FORMAT: summary
        run: |
          $utf8 = [System.Text.UTF8Encoding]::new($false)
          [Console]::InputEncoding = $utf8
          [Console]::OutputEncoding = $utf8
          $OutputEncoding = $utf8
          chcp 65001 > $null
          uv run python -u main.py

      - name: save storage-states cache
        if: hashFiles('storage-states/*.json') != ''
        uses: actions/cache/save@v4
        with:
          path: |
            storage-states
          key: storage-state-${{ hashFiles('storage-states/*.json') }}

      - name: upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: anyrouter-artifacts-${{ github.run_number }}
          path: |
            logs/
            screenshots/
          if-no-files-found: ignore
          retention-days: 7
